# Steps to "quark" an existing Java project

## Instructions

### Building to JVM and dev mode

In lieu of an existing Java project, we are going to use a Thorntail project example generated by the MicroProfile Starter.

1. Open a Terminal window on your laptop (for Windows users, please refer to the following [link](https://github.com/eclipse/microprofile-starter/blob/master/src/main/resources/REST-README.md#powershell-examples) for appropriate syntax)
2. Change directory to one of your choice (I used $HOME/Downloads)
3. Enter the following command to generate a sample MicroProfile project for Thorntail
```
  curl -O -J 'https://start.microprofile.io/api/project?supportedServer=THORNTAIL_V2&mpVersion=MP22'
```
4. The previous command should download a file name demo.zip to your local directory. Unzip the file. This will create a subdirectory called "demo"
5. Create a sub-directory called "Qproj4MP" (side-by-side next to the "demo" sub-directory) by entering the following command:
```
  mkdir Qproj4MP
```
6. Change directory into Qproj4MP
```
  cd Qproj4MP
```  
7. Enter the following command to generate an empty Quarkus project with all the necessary MicroProfile extensions:
```
  mvn io.quarkus:quarkus-maven-plugin:0.21.2:create \
    -DprojectGroupId=com.example \
    -DprojectArtifactId=demo \
    -Dextensions="smallrye-health, smallrye-metrics, smallrye-openapi, smallrye-fault-tolerance, smallrye-jwt, resteasy, rest-client, resteasy-jsonb"
```    
8. Delete the "src" sub-directory for the newly created Quarkus project:
```
  rm -rf ./src
```
9. Copy the contents of the service-a "src" directory from the Thorntail project into the newly created Quarkus project:
```
  cp -pR ../demo/service-a/src .
```  
10. Quarkus expects web app files to reside under the META-INF/resources sub-directory which did not exist in the Thorntail project that you just copied to the newly created Quearkus project directory. So create one by entering the following command:
```
  mkdir src/main/resources/META-INF/resources
``` 
11. Copy the index.html file to the newly created resources sub-directory:
```
  cp src/main/webapp/index.html src/main/resources/META-INF/resources
```  
12. Quarkus also expects the application.properties file to reside under the META-INF/resources sub-directory so copy the microprofile-config.properties file to the correct sub-directory:
```
  cp -p src/main/resources/META-INF/microprofile-config.properties src/main/resources/application.properties
```  
13. Open src/main/resources/application.properties in your favorite editor and append the following two lines to it:
```
quarkus.ssl.native=true
quarkus.smallrye-jwt.enabled=false
```
14. Open pom.xml (located at ./Qproj4MP/src/pom.xml) in your favorite editor and add the following dependencies to it (ensure to insert these lines within the <dependencies> block in the pom.xml):
```
<dependency>
  <groupId>org.bouncycastle</groupId>
  <artifactId>bcpkix-jdk15on</artifactId>
  <version>1.53</version>
</dependency>
<dependency>
  <groupId>com.nimbusds</groupId>
  <artifactId>nimbus-jose-jwt</artifactId>
  <version>6.7</version>
</dependency>
```
15. At this point, you're ready to run the application in dev mode. To do so, enter the following command:
```
  ./mvnw compile quarkus:dev
```
16. Once the application is up and running, go to your favorite browser and open the following URL:
```
http://localhost:8080/index.html
```

The page will show the landing page for the example code for service-a generated by the MicroProfile Starter. Remember that this application is now running in Quarkus dev mode. You can make changes to the source code and live re-loads of the Quarkus engine will occur in the background so that you can see your changes take effect immediately in the web application.
```
NOTE: the JWT Propagation and REST Client calls will fail because you don't have a service-b up and
running at this point. If you'd like to have a service-b, follow the instructions found in
demo/service-b/readme.md (from step 4 above) to build and run service-b. Once service-b is up and
running, the JWT Propagation and REST Client calls should work. If JWT Propagation does not work,
you may need to copy the file demo/service-b/src/main/resources/META-INF/MP-JWT-SIGNER and rename it
to demo/service-b/src/main/resources/META-INF/publicKey.pem. To do this, enter the following command:

cp -p ../demo/service-b/src/main/resources/META-INF/MP-JWT-SIGNER ../demo/service-b/src/main/resources/META-INF/publicKey.pem
```
17. At this point, you can stop the application running in dev mode by entering CTRL-C at the Terminal window in which it has been running
18. To generate the executable JAR for the application, enter the following command in the Terminal window:
```
./mvnw clean package
```
19. And to run the executable JAR file, enter:
```
java -jar target/demo-1.0-SNAPSHOT-runner.jar
```

### Compiling to native

To compile the application to native code, we need to make some more changes to the source code.

1. Ensure you are still in the directory "Qproj4MP". If not, please change directory to it.
2. Edit the file "src/main/java/com/example/demo/config/ConfigTestController.java" in your favorite editor. Replace the line:
```
private String injectedValue;
```
with
```
String injectedValue;
```
3. Edit file file "src/main/java/com/example/demo/client/ClientController.java" in your favorite editor. Replace the line:
```
private Service service;
```
with
```
Service service;
```
4. Edit the file "src/main/java/com/example/demo/metric/MetricController.java" in your favorite editor. Delete the following line:
```
import javax.ws.rs.core.Response;
```
and replace the line:
```
private Counter counter;
```
with
```
Counter counter;
```
5. Edit the file "src/main/java/com/example/demo/secure/MPJWTToken.java" and replace its entire content with the content from the following [link](https://raw.githubusercontent.com/cealsair/codeone2019/master/Quarking-an-existing-Java-project/MPJWTToken.java).

6. Edit the file "src/main/java/com/example/demo/secure/TestSecureController.java" and replace its entire content with the content from the following [link](https://raw.githubusercontent.com/cealsair/codeone2019/master/Quarking-an-existing-Java-project/TestSecureController.java).

7. Open pom.xml (located at ./Qproj4MP/src/pom.xml) in your favorite editor and replace the following dependencies:
```
<dependency>
  <groupId>org.bouncycastle</groupId>
  <artifactId>bcpkix-jdk15on</artifactId>
  <version>1.53</version>
</dependency>
<dependency>
  <groupId>com.nimbusds</groupId>
  <artifactId>nimbus-jose-jwt</artifactId>
  <version>6.7</version>
</dependency>
```
with (ensure these lines within the <dependencies> block in the pom.xml):
```
<dependency>
  <groupId>io.vertx</groupId>
  <artifactId>vertx-auth-jwt</artifactId>
  <version>3.8.1</version>
</dependency>
```
Also, in the pom.xml, replace the following configuration parameter:
```
<configuration>
  <enableHttpUrlHandler>true</enableHttpUrlHandler>
</configuration>
```
with
```
<configuration>
  <enableHttpUrlHandler>true</enableHttpUrlHandler>
  <additionalBuildArgs>-H:Log=registerResource:</additionalBuildArgs>
  <additionalBuildArgs>-H:IncludeResources=privateKey.pem</additionalBuildArgs>
</configuration>
```
8. Edit the file "src/main/resources/privateKey.pem" and replace its entire content with the content from the following [link](https://raw.githubusercontent.com/cealsair/codeone2019/master/Quarking-an-existing-Java-project/privateKey.pem) 
9. At this point, you are ready to compile to native. Enter the following command in your Terminal window:
```
./mvnw package -Pnative
```
10. Finally, to run the executable, enter the following command:
```
./target/demo-1.0-SNAPSHOT-runner -Dinjected.value="hi" -Dvalue="hola"
```
#### Converting service-b to work with Quarkus
  
You will notice that the call the JWT Propagation use case fails when calling service-b. To make service-b work with the natively-compiled service-a, you will need to make some modifications to service-b. The following steps summarize the updates to make service-b work with the natively compiled service-a. Open a second Terminal window and execute the following steps from it.

1. In the same directory where you created "Qproj4MP", create another directory called "Qproj4MPb" by entering the following command at the second Terminal window:
```
mkdir Qproj4MPb
```
2. Change directory into Qproj4MPb
```
  cd Qproj4MPb
```  
3. Enter the following command to generate an empty Quarkus project with all the necessary MicroProfile extensions:
```
  mvn io.quarkus:quarkus-maven-plugin:0.21.2:create \
    -DprojectGroupId=com.example \
    -DprojectArtifactId=demo \
    -Dextensions="smallrye-health, smallrye-metrics, smallrye-openapi, smallrye-fault-tolerance, smallrye-jwt, resteasy, rest-client, resteasy-jsonb"
```    
4. Delete the "src" sub-directory for the newly created Quarkus project:
```
  rm -rf ./src
```
5. Copy the contents of the service-a "src" directory from the Thorntail project into the newly created Quarkus project:
```
  cp -pR ../demo/service-b/src .
```
6. Edit the file "src/main/java/com/example/demo/secure/ProtectedController.java" in your favorite editor. Replace the line:
```
private ClaimValue<String> custom;
```
with
```
ClaimValue<String> custom;
```
7. Create a resources sub-directory under META-INF as follows:
```
mkdir src/main/resources/META-INF/resources
```
8. Create the file "src/main/resources/META-INF/resources/privateKey.pem" and paste into it the content from the following [link](https://raw.githubusercontent.com/cealsair/codeone2019/master/Quarking-an-existing-Java-project/publicKey.pem) 
9. Create the file "src/main/resources/application.properties" and paste the following content into it:
```
quarkus.ssl.native=true
mp.jwt.verify.publickey.location=META-INF/resources/publicKey.pem
mp.jwt.verify.issuer=https://server.example.com
quarkus.smallrye-jwt.auth-mechanism=MP-JWT
quarkus.smallrye-jwt.enabled=true
```
10. At this point, you are ready to build service-b. Enter the following command:
```
mvn clean package
```
11. To run the executable JAR for service-b, enter:
```
java -Dquarkus.http.port=8180 -jar target/demo-1.0-SNAPSHOT-runner.jar
```
12. At this point, you can try the JWT Propagation option from the web app on http://localhost:8080/index.html to verify that it works.
